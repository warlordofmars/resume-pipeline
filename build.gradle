/*
 * resume/build.gradle
 */

import java.util.Random

buildscript {
    repositories {
        mavenCentral()
        maven { url "https://plugins.gradle.org/m2/" }
    }
    dependencies {
        classpath "jp.classmethod.aws:gradle-aws-plugin:0.30"
        classpath "javax.xml.bind:jaxb-api:2.3.0"
    }
}

plugins {
    id 'pl.allegro.tech.build.axion-release' version '1.10.0'
}

project.version = scmVersion.version

ext {
    cloudformationBucket = 'warlordofmars-cloudformation'
    testWebsiteUrl = 'resume-test.warlordofmars.net'
    prodWebsiteUrl = 'resume.warlordofmars.net'
    testStackName = "ResumeWebsiteTest"
    prodStackName = 'ResumeWebsite'
    cloudformationSource = 'website.yaml'
    domainName = 'warlordofmars.net'
    wildcardCertARN = "arn:aws:acm:us-east-1:247631471946:certificate/471106fc-e3dd-4e0b-a20f-010a6e326283"
    productionBranch = 'master'
    ensureStrings = ['John A. Carter', 'johncarter@warlordofmars.net', '(770) 598-7096']
    resumeSource = 'resume.json'
    htmlResumeTheme = 'theme/node_modules/jsonresume-theme-class/'
    pdfResumeTheme = 'theme/node_modules/jsonresume-theme-short/'
    spellCheckIgnoreList = 'spell_check_ignore.txt'
    resumeFormats = ['html', 'pdf', 'yml', 'md', 'json']
    productionNumberOfCopies = 10
}

if (!project.hasProperty('previewHtmlFileName')) {
    def random = new Random()
    def randomNumber = random.nextInt() & Integer.MAX_VALUE
    ext.previewHtmlFileName = "resume-preview-${randomNumber}.html"
}

if (!project.hasProperty('productionHtmlFileName')) {
    ext.productionHtmlFileName = 'index.html'
}

 def gitBranch() {
    def branch = ""
    def proc = "git rev-parse --abbrev-ref HEAD".execute()
    proc.in.eachLine { line -> branch = line }
    proc.err.eachLine { line -> println line }
    proc.waitFor()
    branch
}

def isProd() {
    return (gitBranch() == productionBranch)
}

def getWebsiteUrl() {
    return ( isProd() ? prodWebsiteUrl : testWebsiteUrl)
}

def getStackName() {
    return ( isProd() ? prodStackName : testStackName)
}

def getHtmlResumeName() {
    return ( isProd() ? productionHtmlFileName : previewHtmlFileName)
}

def getNumberOfCopies() {
    return ( isProd() ? productionNumberOfCopies : 1 )
}

ext.stackName = getStackName()
ext.websiteUrl = getWebsiteUrl()

